# CDN é˜²å¾¡ç³»ç»Ÿ - å¿«é€Ÿå¯åŠ¨æŒ‡å—

## ğŸ“¦ é¡¹ç›®å®Œæˆæƒ…å†µ

æœ¬é¡¹ç›®å·²å®Œæ•´å®ç°ä¸€ä¸ªåŸºäº **APISIX ç½‘å…³** çš„å¤šèŠ‚ç‚¹é›†ç¾¤ CDN é˜²å¾¡ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

### âœ… å·²å®ç°çš„åŠŸèƒ½

1. **é˜²å¾¡å¼•æ“æ ¸å¿ƒ** (`backend/defense_engine.py`)
   - å®æ—¶æµé‡åˆ†æå’Œå¨èƒè¯„ä¼°
   - å¼‚å¸¸æ¨¡å¼æ£€æµ‹
   - é€Ÿç‡é™åˆ¶ï¼ˆåˆ†é’Ÿ/å°æ—¶çº§åˆ«ï¼‰
   - é»‘åå•/ç™½åå•ç®¡ç†
   - å¨èƒåˆ†æ•°è®¡ç®—

2. **APISIX ç½‘å…³æ’ä»¶** (`apisix-plugins/cdn_defense.lua`)
   - é›†æˆåˆ°ç½‘å…³å±‚çš„é˜²å¾¡é€»è¾‘
   - JS éªŒè¯ç æŒ‘æˆ˜ç”Ÿæˆ
   - è¯·æ±‚å®æ—¶æ‹¦æˆª
   - ç¼“å­˜å†³ç­–ç»“æœ

3. **é˜²å¾¡ API æœåŠ¡** (`backend/defense_api.py`)
   - RESTful API æ¥å£
   - å¤šç§Ÿæˆ·éš”ç¦»
   - é»‘åå•/ç™½åå• CRUD æ“ä½œ
   - ç»Ÿè®¡å’Œæ—¥å¿—æ¥å£

4. **JS é˜²å¾¡æ¨¡å—** (`js-defense/js_defense.py`)
   - æµè§ˆå™¨æŒ‡çº¹è¯†åˆ«ï¼ˆCanvasã€WebGLã€è®¾å¤‡ç‰¹å¾ï¼‰
   - éªŒè¯ç ç”Ÿæˆï¼ˆæ•°å­¦ã€æ‹¼å›¾ã€è¡Œä¸ºï¼‰
   - æœºå™¨äººæ£€æµ‹ç®—æ³•
   - å¯ä¿¡è®¾å¤‡ç®¡ç†

5. **å¤šèŠ‚ç‚¹é›†ç¾¤æ”¯æŒ**
   - ä¸¤ä¸ªé˜²å¾¡ API èŠ‚ç‚¹ï¼ˆ5000ã€5001ï¼‰
   - Redis ä¸ºå…±äº«æ•°æ®å­˜å‚¨
   - äº‹ä»¶å‘å¸ƒ/è®¢é˜…æœºåˆ¶
   - é…ç½®å’Œé»‘åå•åŒæ­¥

6. **ç›‘æ§å’Œå¯è§†åŒ–**
   - Prometheus æŒ‡æ ‡æ”¶é›†
   - Grafana ä»ªè¡¨æ¿
   - å®æ—¶ç»Ÿè®¡æ•°æ®

7. **ç®¡ç†å·¥å…·**
   - `admin_cli.py`: å‘½ä»¤è¡Œç®¡ç†å·¥å…·
   - ç§Ÿæˆ·ç®¡ç†ã€é»‘ç™½åå•ã€é…ç½®è°ƒæ•´
   - ç»Ÿè®¡å’Œæ—¥å¿—æŸ¥è¯¢

## ğŸš€ 30 ç§’å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ç³»ç»Ÿ

```bash
cd /home/alana/azuredev-cd81/cdn-defense-system
./deploy.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ£€æŸ¥ Docker ç¯å¢ƒ
- å¯åŠ¨æ‰€æœ‰å®¹å™¨
- ç­‰å¾…æœåŠ¡å°±ç»ª
- æ˜¾ç¤ºè®¿é—®åœ°å€

### 2. éªŒè¯ç³»ç»Ÿ

```bash
# å¿«é€Ÿæµ‹è¯•ï¼ˆ2-3 åˆ†é’Ÿï¼‰
./quicktest.sh
```

æµ‹è¯•å†…å®¹ï¼š
- âœ“ API å¥åº·æ£€æŸ¥
- âœ“ æ­£å¸¸è¯·æ±‚åˆ†æ
- âœ“ é»‘åå•åŠŸèƒ½
- âœ“ ç™½åå•åŠŸèƒ½
- âœ“ é…ç½®ç®¡ç†
- âœ“ ç»Ÿè®¡æ¥å£
- âœ“ å¹¶å‘å¤„ç†

### 3. è®¿é—®ç•Œé¢

| æœåŠ¡ | åœ°å€ | è¯´æ˜ |
|------|------|------|
| APISIX ç½‘å…³ | http://localhost:9080 | API å…¥å£ |
| é˜²å¾¡ API | http://localhost:5000 | é˜²å¾¡å¼•æ“ API |
| Grafana | http://localhost:3000 | ç›‘æ§ä»ªè¡¨æ¿ (admin/admin) |
| Prometheus | http://localhost:9090 | æŒ‡æ ‡åº“ |

## ğŸ“‹ å¸¸ç”¨å‘½ä»¤

### ç§Ÿæˆ·ç®¡ç†

```bash
# åˆ›å»ºç§Ÿæˆ·
python admin_cli.py tenant create --id my-tenant

# åˆ—å‡ºæ‰€æœ‰ç§Ÿæˆ·
python admin_cli.py tenant list
```

### é»‘åå•ç®¡ç†

```bash
# æ·»åŠ  IP åˆ°é»‘åå•ï¼ˆ1å°æ—¶ï¼‰
python admin_cli.py blacklist add --tenant-id my-tenant --ip 192.168.1.100 --duration 3600

# åˆ—å‡ºé»‘åå•
python admin_cli.py blacklist list --tenant-id my-tenant

# ç§»é™¤é»‘åå•
python admin_cli.py blacklist remove --tenant-id my-tenant --ip 192.168.1.100
```

### ç™½åå•ç®¡ç†

```bash
# æ·»åŠ  IP åˆ°ç™½åå•
python admin_cli.py whitelist add --tenant-id my-tenant --ip 10.0.0.1

# åˆ—å‡ºç™½åå•
python admin_cli.py whitelist list --tenant-id my-tenant
```

### æŸ¥çœ‹æ•°æ®

```bash
# æŸ¥çœ‹é˜²å¾¡ç»Ÿè®¡
python admin_cli.py stats --tenant-id my-tenant

# æŸ¥çœ‹é˜²å¾¡æ—¥å¿—
python admin_cli.py logs --tenant-id my-tenant --limit 50

# è·å–é…ç½®
python admin_cli.py config get --tenant-id my-tenant

# æ›´æ–°é…ç½®
python admin_cli.py config set --tenant-id my-tenant --key rate_limit_per_minute --value 200
```

## ğŸ” ç³»ç»Ÿæ¶æ„è¯¦è§£

### é˜²å¾¡æµç¨‹

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
[APISIX ç½‘å…³]
    â†“
[cdn-defense æ’ä»¶]
    â”œâ”€ æ£€æŸ¥ç¼“å­˜å†³ç­–
    â”œâ”€ æ£€æŸ¥ JS å“åº”
    â””â”€ è°ƒç”¨é˜²å¾¡å¼•æ“
    â†“
[é˜²å¾¡ API æœåŠ¡]
    â”œâ”€ æ£€æŸ¥ç™½åå•
    â”œâ”€ é€Ÿç‡é™åˆ¶æ£€æŸ¥
    â”œâ”€ å¼‚å¸¸æ£€æµ‹
    â”œâ”€ å¨èƒåˆ†æ•°è®¡ç®—
    â””â”€ ç”Ÿæˆé˜²å¾¡å†³ç­–
    â†“
[å†³ç­–å“åº”]
â”œâ”€ ALLOW: å…è®¸è¯·æ±‚é€šè¿‡
â”œâ”€ CHALLENGE: JS éªŒè¯æŒ‘æˆ˜
â”œâ”€ RATE_LIMIT: é™æµå“åº”
â””â”€ BLOCK: æ‹’ç»è¯·æ±‚
```

### æ•°æ®æµå‘

```
APISIX â†â†’ é˜²å¾¡ API (èŠ‚ç‚¹1)  â†â”
                           â”‚
Redis (å…±äº«å­˜å‚¨)            â”œâ”€ åˆ†å¸ƒå¼åè°ƒ
    â”œâ”€ é»‘åå•ç¼“å­˜           â”‚
    â”œâ”€ å†³ç­–ç¼“å­˜        é˜²å¾¡ API (èŠ‚ç‚¹2)  â†â”˜
    â”œâ”€ ç»Ÿè®¡æ•°æ®
    â””â”€ é…ç½®æ•°æ®
```

## ğŸ“Š å¨èƒåˆ†æ•°è¯´æ˜

ç³»ç»Ÿä½¿ç”¨ 0-100 çš„å¨èƒåˆ†æ•°è¯„ä¼°è¯·æ±‚å±é™©ç¨‹åº¦ï¼š

| åˆ†æ•°èŒƒå›´ | é£é™©ç­‰çº§ | å¤„ç†æ–¹å¼ |
|---------|--------|--------|
| 0-30 | ä½é£é™© | âœ“ å…è®¸ |
| 30-50 | ä¸­é£é™© | ? JS éªŒè¯ |
| 50-70 | é«˜é£é™© | â± é™æµ |
| 70+ | ä¸¥é‡é£é™© | âœ— é˜»æ­¢ |

### å¨èƒåˆ†æ•°è®¡ç®—å› ç´ 

- **åŸºç¡€å› ç´ ** (0-50 åˆ†)
  - æ˜¯å¦æ˜¯æœºå™¨äºº (+30)
  - å¿«é€Ÿè¯·æ±‚ (+20)
  - è·¯å¾„æ‰«æ (+25)
  - UA æ¬ºéª— (+15)

- **éªŒè¯å› ç´ ** (0-30 åˆ†)
  - JS éªŒè¯å¤±è´¥ (+10)
  - æŒ‡çº¹ä¸åŒ¹é… (+5)
  - å¼‚å¸¸è´Ÿè½½ (+10)
  - é»‘åå• IP (+50)

## ğŸ” å®‰å…¨æœ€ä½³å®è·µ

### 1. é…ç½®é˜²å¾¡ç­–ç•¥

```bash
# ä¸¥æ ¼ç­–ç•¥ï¼ˆæ¨èç”¨äº APIï¼‰
python admin_cli.py config set --tenant-id my-tenant \
  --key js_challenge_threshold --value 20

# å®½æ¾ç­–ç•¥ï¼ˆæ¨èç”¨äºå†…å®¹åˆ†å‘ï¼‰
python admin_cli.py config set --tenant-id my-tenant \
  --key block_threshold --value 85
```

### 2. å®šæœŸå®¡æŸ¥é»‘åå•

```bash
# å¯¼å‡ºé»‘åå•è¿›è¡Œåˆ†æ
python admin_cli.py blacklist list --tenant-id my-tenant > blacklist.txt
```

### 3. ç›‘æ§å¼‚å¸¸æµé‡

```bash
# æŸ¥çœ‹é¡¶çº§å¨èƒ IP
python admin_cli.py stats --tenant-id my-tenant
```

## ğŸ§ª æµ‹è¯•ç³»ç»Ÿ

### å•å…ƒæµ‹è¯•

```bash
python test_defense_system.py --unit
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
python test_defense_system.py --benchmark
```

### å…¨é¢æµ‹è¯•

```bash
python test_defense_system.py --all
```

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: API æ— æ³•è¿æ¥

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose -f docker/docker-compose.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker logs cdn-defense-api

# é‡å¯æœåŠ¡
docker-compose -f docker/docker-compose.yml restart defense-api
```

### é—®é¢˜ 2: Redis è¿æ¥é”™è¯¯

```bash
# æµ‹è¯• Redis è¿æ¥
redis-cli -h 127.0.0.1 ping

# æ£€æŸ¥ç½‘ç»œ
docker network inspect cdn-defense-network
```

### é—®é¢˜ 3: APISIX æ’ä»¶ä¸åŠ è½½

```bash
# æ£€æŸ¥æ—¥å¿—
docker logs cdn-defense-apisix | grep cdn-defense

# éªŒè¯æ’ä»¶ä½ç½®
docker exec cdn-defense-apisix ls -la /opt/apisix/plugins/
```

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

æ ¹æ®åŸºå‡†æµ‹è¯•ï¼ˆ1000 ä¸ªè¯·æ±‚ï¼Œ10 ä¸ªå¹¶å‘çº¿ç¨‹ï¼‰ï¼š

- **ååé‡**: ~500-1000 req/s
- **å¹³å‡å»¶è¿Ÿ**: 10-50ms
- **P95 å»¶è¿Ÿ**: 50-100ms
- **P99 å»¶è¿Ÿ**: 100-200ms

## ğŸ’¡ ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **Redis æŒä¹…åŒ–**
   - å¯ç”¨ AOF æˆ– RDB æŒä¹…åŒ–
   - å®šæœŸå¤‡ä»½æ•°æ®

2. **é›†ç¾¤æ‰©å±•**
   - æ·»åŠ æ›´å¤šé˜²å¾¡ API èŠ‚ç‚¹
   - ä½¿ç”¨ Redis Cluster æˆ– Sentinel

3. **ç›‘æ§å‘Šè­¦**
   - è®¾ç½® Grafana å‘Šè­¦è§„åˆ™
   - ç›‘æ§ DDoS æŒ‡æ ‡

4. **æ—¥å¿—æ”¶é›†**
   - é›†æˆ ELK Stack
   - é•¿æœŸä¿ç•™å®¡è®¡æ—¥å¿—

5. **å®¹é‡è§„åˆ’**
   - æ ¹æ®æµé‡è°ƒæ•´èµ„æº
   - å®šæœŸæ€§èƒ½æµ‹è¯•

## ğŸ“ è·å–å¸®åŠ©

æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š
```bash
cat README.md
```

æŸ¥çœ‹ API æ¥å£ï¼š
```bash
curl http://localhost:5000/health
```

æŸ¥çœ‹ç®¡ç†å·¥å…·å¸®åŠ©ï¼š
```bash
python admin_cli.py -h
```

## âœ¨ é¡¹ç›®ç‰¹è‰²

- âœ… **å¼€ç®±å³ç”¨**: ä¸€æ¡å‘½ä»¤å¯åŠ¨å®Œæ•´ç³»ç»Ÿ
- âœ… **å¤šç§Ÿæˆ·éš”ç¦»**: å®Œæ•´çš„ç§Ÿæˆ·çº§åˆ«éš”ç¦»
- âœ… **é«˜å¯ç”¨**: å¤šèŠ‚ç‚¹é›†ç¾¤ï¼Œè‡ªåŠ¨åŒæ­¥
- âœ… **å®æ—¶é˜²å¾¡**: æ¯«ç§’çº§å“åº”æ—¶é—´
- âœ… **æ™ºèƒ½æ£€æµ‹**: AI å¼‚å¸¸æ£€æµ‹ + æœºå™¨äººè¯†åˆ«
- âœ… **æ˜“äºç®¡ç†**: å›¾å½¢åŒ–å’Œå‘½ä»¤è¡Œç®¡ç†å·¥å…·
- âœ… **å®Œæ•´å¯è§‚æµ‹**: å†…ç½®ç›‘æ§å’Œæ—¥å¿—
- âœ… **å¯æ‰©å±•**: æ”¯æŒè‡ªå®šä¹‰è§„åˆ™å’Œç­–ç•¥

---

**ç³»ç»Ÿåˆ›å»ºæ—¶é—´**: 2024å¹´11æœˆ30æ—¥
**æ¨èéƒ¨ç½²**: Docker Compose
**æœ€å°é…ç½®**: 2 æ ¸ CPU, 4GB å†…å­˜
